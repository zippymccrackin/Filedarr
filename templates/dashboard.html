<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>File Transfer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 1em;
      margin: 0;
      transition: background 0.3s, color 0.3s;
    }

    body.dark {
      background: #1e1e1e;
      color: #f0f0f0;
    }

    h1 {
      font-size: 1.75em;
      margin-bottom: 0.5em;
    }

    .section {
      margin-bottom: 2em;
    }

    .section h2 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.2em;
      margin-top: 1em;
      cursor: pointer;
    }

    .toggle-btn {
      background: none;
      border: none;
      font-size: 1em;
      color: inherit;
      cursor: pointer;
    }

    .transfer {
      background: #fff;
      padding: 1em;
      margin: 0.5em 0;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
    }

    body.dark .transfer {
      background: #2c2c2c;
    }

    .progress-bar {
      background: #ddd;
      border-radius: 6px;
      overflow: hidden;
      height: 20px;
      margin-top: 4px;
    }

    .progress-fill {
      height: 100%;
      transition: width 0.5s, background 0.5s;
    }

    .controls {
      margin-bottom: 1em;
    }

    button {
      margin-right: 10px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 1em;
    }

    @media (max-width: 600px) {
      .transfer {
        font-size: 0.9em;
      }

      h1 {
        font-size: 1.3em;
      }
    }

    .transfer {
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      background: #1e1e1e;
      color: white;
    }

    .progress-bar {
      height: 8px;
      width: 100%;
      background-color: #333;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      transition: width 0.4s ease;
    }

    *:has(.tooltiptext) {
      position: relative;
    }

    .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: black;
      color: #fff;
      text-align: center;
      padding: 5px 0;
      border-radius: 6px;

      /* Position the tooltip text - see examples below! */
      position: absolute;
      z-index: 1;
    }

    *:has(> .tooltiptext):hover .tooltiptext {
      visibility: visible;
    }

    .remove-btn {
      background: #c62828;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
      transition: background 0.3s ease;
      float: right;
      margin: 0;
    }

    #removeCompletedTransfersBtn[disabled] {
      display: none;
    }

    .remove-btn:hover {
      background: #b71c1c;
    }

    .transfer-container {
      position: relative;
    }

    @keyframes fadeOutUp {
      0% {
        opacity: 1;
        transform: translateY(0);
      }

      100% {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    .fade-out {
      animation: fadeOutUp 0.4s ease forwards;
    }
  </style>
</head>

<body>
  <h1>üì¶ File Transfer Dashboard</h1>

  <div class="controls">
    <button onclick="toggleDarkMode()">üåì Toggle Dark Mode</button>
  </div>

  <div class="section" id="current-section">
    <h2 onclick="toggleSection('current')">
      ‚è≥ Current Transfers
      <span id="current-toggle">[-]</span>
    </h2>
    <div id="current-transfers"></div>
  </div>

  <div class="section" id="completed-section">
    <h2 onclick="toggleSection('completed')">
      ‚úÖ Completed Transfers
      <span id="completed-toggle">[-]</span>
    </h2>
    <button onclick="removeAllCompleted()" id="removeCompletedTransfersBtn"
      style="font-size: 0.8em; padding: 4px 10px; background: #c62828; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%">
      ‚úñ Remove All Completed Transfers
    </button>
    <div id="completed-transfers"></div>
    <div class="pagination" id="completed-pagination"></div>
  </div>

  <script>
    const dashboard = {
      current: document.getElementById('current-transfers'),
      completed: document.getElementById('completed-transfers'),
      completedPagination: document.getElementById('completed-pagination'),
    };

    let latestData = {};
    let completedTransfers = [];
    const itemsPerPage = 5;

    function toggleDarkMode() {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark ? 'true' : 'false');
    }

    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
    }

    let currentCompletedPage = localStorage.getItem('currentCompletedPage') || 1;
    currentCompletedPage = parseInt(currentCompletedPage);
    function setCurrentCompletedPage(page) {
      currentCompletedPage = page;
      localStorage.setItem('currentCompletedPage', page);
    }

    function toggleSection(section) {
      const content = document.getElementById(`${section}-transfers`);
      const toggle = document.getElementById(`${section}-toggle`);
      const isHidden = content.style.display === 'none';
      content.style.display = isHidden ? '' : 'none';
      toggle.textContent = isHidden ? '[-]' : '[+]';
    }

    function getBackgroundColor(percent) {
      if (percent < 34) return 'red';
      if (percent < 67) return 'orange';
      return 'green';
    }

    function getForegroundColor(percent) {
      if (percent < 34) return 'white';
      if (percent < 67) return 'white';
      return 'lime';
    }

    function sortTransfersByETA(transfers) {
      return transfers.sort((a, b) => (a.eta || '').localeCompare(b.eta || ''));
    }

    function renderTransferItem(item) {
      const percent = parseFloat(item.percent_complete?.replace('%', '')) || 0;

      let name = item.meta?.name || "Unknown Title";
      const season = item.meta?.seasonNumber?.toString().padStart(2, '0') || undefined;
      const episode = item.meta?.episodeNumber?.toString().padStart(2, '0') || undefined;
      const episodeTitle = item.meta?.episodeTitles || ""
      let poster = item.tvdb?.image || item.tmdb?.image || undefined;

      if (poster == undefined && item.tmdb?.poster_path) {
        poster = `https://image.tmdb.org/t/p/w500/${item.tmdb.poster_path}`;
      }

      if (item.meta?.year) {
        name += ` (${item.meta.year})`;
      }

      let seasonEpisodeDisplay = "";
      if (season != undefined && episode != undefined) {
        seasonEpisodeDisplay = `S${season}E${episode}`;
      }
      if (episodeTitle) {
        seasonEpisodeDisplay += ` ${episodeTitle}`;
      }

      const speedColor =
        item.speed_mb_s >= 4 ? 'lightgreen' :
          item.speed_mb_s >= 1 ? 'orange' :
            'red';

      const chunkTxt = (item.chunk_size !== undefined && item.delay_ms !== undefined)
        ? `<br>Chunk Size: <span class="chunkSize">${item.chunk_size}</span> Delay: <span class="delayMs">${item.delay_ms}</span>ms`
        : "";

      const transferContainer = document.createElement('div');
      transferContainer.id = item.id;
      transferContainer.className = 'transfer-container';

      const transfer = document.createElement('div');
      transfer.className = 'transfer';
      transferContainer.appendChild(transfer);

      // hide these on completed
      let transferredDisplay = "";
      let etaSpeedDisplay = "";
      let relativeTimeDisplay = "";
      if (percent < 100) {
        transferredDisplay = `<span class="transferredMb">${item.transferred_mb}</span>MB /`;
        etaSpeedDisplay = ` <div style="font-size: 0.9em; margin-top: 4px; color: #ccc;">
          <span class="eta">${item.eta}</span> &nbsp;|&nbsp;
          <span class="speedColor" style="color: ${speedColor}">
            <span class="speed">${item.speed_mb_s?.toFixed(2) || '0.00'}</span> MB/s
          </span>
        </div>`;
      } else {
        // lets say how long ago it completed
        relativeTimeDisplay = `<div style="font-size: 0.9em; margin-top: 4px; color: #ccc;">
            Completed <span class="completedTime" data-timestamp="${item.timestamp}">${getRelativeTime(item.timestamp)}</span>
            <span class="tooltiptext">${getFriendlyTime(item.timestamp)}</span>
          </div>`;
      }
      transfer.innerHTML = `
    <div class="transfer-header" style="display: flex; align-items: center; cursor: pointer; padding: 8px; border-radius: 10px; background: #222; margin-bottom: 10px;">
      <img src="${poster}" alt="Poster" style="width: 80px; height: 120px; margin-right: 12px; object-fit: cover; border-radius: 6px;" />
      <div style="flex-grow: 1;">
        <div style="font-size: 1.1em; font-weight: bold;">${name}</div>
        <div style="color: #aaa;">${seasonEpisodeDisplay}</div>

        <div class="progress-bar" style="margin: 10px 0; background: #444; height: 12px; border-radius: 5px;">
          <div class="progress-fill" style="width: ${percent}%; background: ${getBackgroundColor(percent)}; height: 100%; border-radius: 5px; display: flex; justify-content: center;">
            <span class="percentComplete" style="font-size: 75%; color: ${getForegroundColor(percent)};">${percent.toFixed(1)}%</span>  
          </div>
        </div>

        <div>
          ${transferredDisplay}
          <span class="totalMb">${item.total_mb}</span>MB
        </div>
       ${etaSpeedDisplay}
       ${relativeTimeDisplay}
      </div>
    </div>

    <div class="transfer-details" style="display: none; margin-left: 92px; margin-bottom: 12px; font-size: 0.85em; color: #bbb;">
      <strong class="source">${item.source}</strong> ‚Üí <em class="destination">${item.destination}</em><br>
      <span class="message">${item.message}</span>
      ${chunkTxt}
    </div>
  `;

      // Toggle expanded info on click
      const header = transfer.querySelector('.transfer-header');
      const details = transfer.querySelector('.transfer-details');
      header.addEventListener('click', () => {
        details.style.display = details.style.display === 'none' ? 'block' : 'none';
      });

      // Only show remove button if it's completed
      if (percent >= 100) {
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.textContent = '‚úñ';
        removeBtn.onclick = (e) => {
          e.stopPropagation(); // Don't toggle details on click
          fetch(`/transfer/${item.id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          }).then(res => {
            if (!res.ok) {
              alert("Failed to delete transfer");
            }
          });
        };
        const firstDiv = header.querySelector("div");
        firstDiv.insertBefore(removeBtn, firstDiv.firstChild);
      }

      return transferContainer;
    }

    function renderCompletedTransfersPage() {
      dashboard.completed.innerHTML = '';
      const start = (currentCompletedPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = completedTransfers.slice(start, end);
      pageItems.forEach(item => {
        dashboard.completed.appendChild(renderTransferItem(item));
      });

      const totalPages = Math.ceil(completedTransfers.length / itemsPerPage);
      renderPaginationControls(totalPages);

      document.getElementById("removeCompletedTransfersBtn").disabled = completedTransfers.length==0
    }

    function renderPaginationControls(totalPages) {
      const controls = dashboard.completedPagination;
      controls.innerHTML = '';

      if (totalPages <= 1) return;

      const prevBtn = document.createElement('button');
      prevBtn.textContent = '‚¨Ö Prev';
      prevBtn.disabled = currentCompletedPage === 1;
      prevBtn.onclick = () => {
        setCurrentCompletedPage(currentCompletedPage-1);
        renderCompletedTransfersPage();
      };

      const nextBtn = document.createElement('button');
      nextBtn.textContent = 'Next ‚û°';
      nextBtn.disabled = currentCompletedPage === totalPages;
      nextBtn.onclick = () => {
        setCurrentCompletedPage(currentCompletedPage + 1);
        renderCompletedTransfersPage();
      };

      const info = document.createElement('span');
      info.textContent = `Page ${currentCompletedPage} of ${totalPages}`;

      controls.appendChild(prevBtn);
      controls.appendChild(info);
      controls.appendChild(nextBtn);
    }

    function renderDashboard(data) {
      latestData = data;
      dashboard.current.innerHTML = '';

      const allTransfers = Object.values(data).flat();

      const current = sortTransfersByETA(allTransfers.filter(t => parseFloat(t.percent_complete) < 100));
      completedTransfers = allTransfers.filter(t => parseFloat(t.percent_complete) >= 100);

      current.forEach(item => {
        dashboard.current.appendChild(renderTransferItem(item));
      });

      const totalPages = Math.ceil(completedTransfers.length / itemsPerPage);
      if (currentCompletedPage > totalPages) {
        setCurrentCompletedPage(totalPages || 1);
      }

      renderCompletedTransfersPage();
    }

    function getRelativeTime(dateString) {
      const rtf = new Intl.RelativeTimeFormat('en', { numeric: 'auto' });

      const now = new Date();
      const then = new Date(dateString * 1000);
      const diffInSeconds = Math.floor((then - now) / 1000);

      const units = [
        { unit: 'day', seconds: 86400 },
        { unit: 'hour', seconds: 3600 },
        { unit: 'minute', seconds: 60 },
        { unit: 'second', seconds: 1 }
      ];

      for (const { unit, seconds } of units) {
        const absDelta = Math.floor(Math.abs(diffInSeconds) / seconds);
        const sign = diffInSeconds < 0 ? -1 : 1;
        if (absDelta >= 1 || unit === 'second') {
          return capitalizeFirstLetter(rtf.format(sign * absDelta, unit));
        }
      }
    }

    function getFriendlyTime(dateString) {
      const date = new Date(dateString * 1000);
      const options = {
        weekday: 'long', // "Monday"
        year: 'numeric',
        month: 'long', // "June"
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };

      return date.toLocaleString(date, options);
    }

    function capitalizeFirstLetter(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function updateDashboard(data) {
      const element = document.getElementById(data.id);

      if (data.status == "complete") { // let renderCompletedTransfersPage handle it because pagination
        completedTransfers.push(data);
        renderCompletedTransfersPage();

        if (element) {
          element.remove();
        }

        return;
      }

      if (!element) {
        // create element
        dashboard.current.appendChild(renderTransferItem(data));
      } else {
        // just update values
        let chunkElement = element.querySelector(".chunkSize");
        let delayElement = element.querySelector(".delayMs");
        if (data.chunk_size)
          if (data.chunk_size != undefined && data.delay_ms != undefined) {
            chunkElement.innerText = data.chunk_size;
            delayElement.innerText = data.delay_ms;
          } else {
            if (chunkElement) chunkElement.style.display = "none";
            if (delayElement) delayElement.style.display = "none";
          }
        element.querySelector(".source").innerText = data.source;
        element.querySelector(".destination").innerText = data.destination;
        element.querySelector(".message").innerText = data.message;
        element.querySelector(".transferredMb").innerText = data.transferred_mb;
        element.querySelector(".totalMb").innerText = data.total_mb;
        element.querySelector(".eta").innerText = data.eta;
        element.querySelector(".speed").innerText = data.speed_mb_s;

        const perc = parseFloat(data.percent_complete.replace('%', '')) || 0;
        element.querySelector(".percentComplete").innerText = `${perc.toFixed(1)}%`;
        element.querySelector(".progress-fill").style.width = `${perc}%`;
        element.querySelector(".progress-fill").style.background = getBackgroundColor(perc);

        element.querySelector(".speedColor").style.color = `${data.speed_mb_s >= 4 ? 'lightgreen' : data.speed_mb_s >= 1 ? 'orange' : 'red'}`;
      }
    }

    const evtSource = new EventSource("/events");
    evtSource.onmessage = function (event) {
      const payload = JSON.parse(event.data);
      console.log(payload);
      const data = payload.data;
      const action = payload.action.toLowerCase();
      switch (action) {
        case "init":
          renderDashboard(data);
          break;
        case "update":
          updateDashboard(data);
          break;
        case "remove":
          const removedId = data.id;
          const removedElement = document.getElementById(removedId);

          if (removedElement) {
            removedElement.classList.add("fade-out");

            setTimeout(() => {
              completedTransfers = completedTransfers.filter(t => t.id !== removedId);
              renderCompletedTransfersPage();
            }, 400); // match animation duration
          }
          break;
        case "removeall":
          const removedElements = document.querySelectorAll("#completed-transfers .transfer-container");

          if (removedElements.length > 0) {
            document.getElementById("completed-transfers").classList.add("fade-out");

            setTimeout(() => {
              completedTransfers = [];
              renderCompletedTransfersPage();
            }, 400);
          }
          break;
      }
    };

    // recalculate relative times for completions every second
    window.setInterval(() => {
      // get all completedTime elements
      const elements = document.querySelectorAll(".completedTime");

      elements.forEach(ele => {
        ele.innerText = getRelativeTime(ele.dataset.timestamp);
      })
    }, 1000);

    function removeAllCompleted() {
      if (!confirm("Are you sure you want to remove all completed transfers?")) return;

      fetch(`/transfer/all`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      }).then(res => {
        if (!res.ok) {
          console.error(`Failed to delete all items`);
        }
      });
    }
  </script>
</body>

</html>